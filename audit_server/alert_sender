#!/usr/bin/env bash
set -euo pipefail

WEBHOOK="http://10.0.4.220:5123/webhook"
LOG="/var/log/audit/audit.log"

command -v python3 >/dev/null 2>&1 || {
  echo "alert_sender: python3 is required to JSON-encode audit.log lines safely" >&2
  exit 1
}

# Rutas "normales" (permitidas)
ALLOW_PREFIX=(/usr/bin/ /bin/ /usr/sbin/ /sbin/ /usr/local/bin/ /usr/local/sbin/)
# Rutas típicas de dropper / staging (rojas)
BAD_PREFIX=(/tmp/ /var/tmp/ /dev/shm/ /home/ /root/ /opt/ /srv/)

is_allowed() {
  local exe="$1"
  for p in "${ALLOW_PREFIX[@]}"; do [[ "$exe" == "$p"* ]] && return 0; done
  return 1
}
is_bad() {
  local exe="$1"
  for p in "${BAD_PREFIX[@]}"; do [[ "$exe" == "$p"* ]] && return 0; done
  return 1
}

make_payload() {
  # Use Python's JSON encoder so we correctly escape control characters from audit.log
  # (e.g., 0x1d separators), which otherwise makes the JSON invalid.
  ALERT="RED_EXEC" \
    HOST="$(hostname)" \
    EXE="$1" COMM="$2" UID="$3" EUID="$4" AUID="$5" \
    PID="$6" PPID="$7" TTY="$8" KEY="$9" AUDIT="${10}" \
    TEXT="${11}" RAW="${12}" \
    python3 - <<'PY'
import os, json
data = {
  "alert": os.environ.get("ALERT",""),
  "host": os.environ.get("HOST",""),
  "exe": os.environ.get("EXE",""),
  "comm": os.environ.get("COMM",""),
  "uid": os.environ.get("UID",""),
  "euid": os.environ.get("EUID",""),
  "auid": os.environ.get("AUID",""),
  "pid": os.environ.get("PID",""),
  "ppid": os.environ.get("PPID",""),
  "tty": os.environ.get("TTY",""),
  "key": os.environ.get("KEY",""),
  "audit": os.environ.get("AUDIT",""),
  "text": os.environ.get("TEXT",""),
  "raw": os.environ.get("RAW",""),
}
print(json.dumps(data, separators=(",", ":")))
PY
}

tail -Fn0 "$LOG" | while read -r line; do
  # Solo SYSCALL + execve (x86_64: syscall=59)
  [[ "$line" == *"type=SYSCALL"* ]] || continue
  [[ "$line" == *"syscall=59"* ]] || continue
  [[ "$line" == *" success=yes"* ]] || continue

  # Extraer campos del raw
  exe=$(sed -n 's/.* exe="\([^"]*\)".*/\1/p' <<<"$line"); [[ -n "${exe:-}" ]] || continue
  comm=$(sed -n 's/.* comm="\([^"]*\)".*/\1/p' <<<"$line")
  uid=$(sed -n 's/.* uid=\([0-9]\+\).*/\1/p' <<<"$line")
  euid=$(sed -n 's/.* euid=\([0-9]\+\).*/\1/p' <<<"$line")
  auid=$(sed -n 's/.* auid=\([0-9]\+\).*/\1/p' <<<"$line")
  pid=$(sed -n 's/.* pid=\([0-9]\+\).*/\1/p' <<<"$line")
  ppid=$(sed -n 's/.* ppid=\([0-9]\+\).*/\1/p' <<<"$line")
  tty=$(sed -n 's/.* tty=\([^ ]*\).*/\1/p' <<<"$line")
  key=$(sed -n 's/.* key="\([^"]*\)".*/\1/p' <<<"$line")
  msg=$(sed -n 's/.* msg=audit(\([^)]*\)).*/\1/p' <<<"$line")  # "epoch.serial"

  # Señal roja: root + (ruta mala o no permitida)
  [[ "${euid:-}" == "0" || "${uid:-}" == "0" ]] || continue
  if is_bad "$exe" || ! is_allowed "$exe"; then
    # “Texto” estilo humano (sin depender de ausearch)
    text="$(hostname) AUID=${auid:-?} UID=${uid:-?} EUID=${euid:-?} TTY=${tty:-?} ran ${exe} (comm=${comm:-?} pid=${pid:-?} ppid=${ppid:-?} key=${key:-red_exec} audit=${msg:-?})"

    payload="$(make_payload "$exe" "${comm:-}" "${uid:-}" "${euid:-}" "${auid:-}" "${pid:-}" "${ppid:-}" "${tty:-}" "${key:-}" "${msg:-}" "$text" "$line")"

    curl -sS -m 2 -X POST "$WEBHOOK" \
      -H 'Content-Type: application/json' \
      -d "$payload" >/dev/null || true
  fi
done
